---
title: "Untitled"
output: html_document
date: "2024-04-12"
---

```{r}
susie_get_cs_attainable <- function(res, coverage = 0.95, ethres = 20) {
  P = ncol(res$alpha)
  K = nrow(res$alpha)

  gamma_lp <- t(res$alpha)
  # Sort the indices of gamma along each row and column
  vidx <- t(apply(gamma_lp, 1, order, decreasing = TRUE))
  matidx <- (apply(gamma_lp, 2, order, decreasing = TRUE))

  # Create an effective gamma matrix initialized with zeros
  mat_eff <- matrix(0, nrow = P, ncol = K)

  # Fill in the effective gamma matrix with the maximum gamma value for each row
  for (p in 1:P) {
    mat_eff[p, vidx[p, 1]] <- gamma_lp[p, vidx[p, 1]]
  }

  # Calculate the column sums of the effective gamma matrix and round the values
  csum <- round(colSums(mat_eff), 2)

  # Initialize lists to store the effect information
  eff <- list()
  eff_gamma <- list()
  eff_mu <- list()

  # Iterate over each effect group
  for (k in 1:K) {
    # Check if the coverage sum for the current effect group exceeds the coverage threshold
    if (csum[k] > coverage) {
      # Check if the entropy of the effective gamma values for the current effect group is below the entropy threshold
      if (entropy::entropy(mat_eff[, k]) < log(ethres)) {
        # Iterate over each row in the effective gamma matrix
        for (p in 1:P) {
          # Check if the cumulative sum of effective gamma values up to the current row exceeds the coverage threshold
          # or if the effective gamma value for the current row is below a small threshold (0.01)
          if (sum(mat_eff[matidx[1:p, k], k]) > coverage * csum[k] || mat_eff[matidx[p, k], k] < 0.01) {
            # Store the indices of the effective variants for the current effect group
            eff[[k]] <- matidx[1:p, k]
            # Store the rounded effective gamma values for the current effect group
            eff_gamma[[k]] <- round(mat_eff[eff[[k]], k], 4)
            break
          }
        }
      }
    }
  }

  # Return a list containing the effect information
  return(list(eff = eff, eff_gamma = eff_gamma))
}

P <- 5
K <- 3

gamma_values <- matrix(c(0.09784297, 0.62761396, 0.27454307,
 0.729092  , 0.13546541 ,0.13544259,
 0.02001195 ,0.67261832 ,0.30736973,
 0.25890493 ,0.00437364 ,0.73672143,
 0.80260249 ,0.10723697, 0.09016054), nrow = P, ncol = K, byrow = T)

res <- list(alpha = t(gamma_values))
susie_get_cs_attainable(res, coverage = 0.95, ethres = 20)

print(gamma_values)
  
  
```

