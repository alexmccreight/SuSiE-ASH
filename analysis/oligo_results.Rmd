---
title: "Oligogenic Results"
output: html_document
---

## Power Calculation for Causal Definition

In an oligogenic setting, with an infinitesimal background, we cannot simply set our causal variants as those with nonzero effect sizes. Thus, we ran SuSiE with L = 1 on multiple different total PVE settings, each on 150 different LD blocks with n = 1500 and ranging from p = 5000 to p = 8000, and with only a single causal variant. We found at PVE = 0.0225 we can achieve 80% power. 

```{r, echo = F, warning = F, message = F}
library(tidyverse)
mem.maxVSize(48*1024)

# List all .rds files from the directory
files <- list.files(
  "/Users/alexmccreight/Columbia/Research/SuSiE-ASH/SuSiE-ASH/scripts/benchmark/power_calculation",
  pattern = "\\.rds$", full.names = TRUE
)

# Initialize a data frame to store the results
results <- data.frame(h2total = numeric(), CS_Recall = numeric(), stringsAsFactors = FALSE)

# Loop over each file
for (filename in files) {
  # Load the .rds file
  file_data <- readRDS(filename)
  
  # Extract the h2total parameter from the file name.
  # This regex finds the number following "h2total" and before the next underscore.
  h2_value <- as.numeric(sub(".*h2total([0-9.]+)_.*", "\\1", filename))
  
  # Extract the CS_Recall value from the file_data object.
  cs_recall <- file_data$avg_metrics$CS_Recall
  
  # Append the extracted values to the results data frame
  results <- rbind(results, data.frame(h2total = h2_value, CS_Recall = cs_recall))
  
  # Remove the loaded object and run garbage collection to free memory
  rm(file_data)
  gc()
  
  # Inform that the current file has been processed
  message("Processed original file: ", filename)
}

# Create the plot with ggplot2
plot <- ggplot(results, aes(x = h2total, y = CS_Recall)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.8, linetype = "dotted", color = "red") +
  ylim(0, 1) +
  labs(title = "Power Calculation", x = "Total PVE", y = "CS Power") +
  theme_minimal()

# Display the plot
print(plot)

```

## FDR & Power Plots

The following plots show the FDR and Power for our oligogenic simulation setting across four heritability levels, each with 150 replicates resulting in 4 * 150 = 600 total simulated data sets. 

- Fineboost was ran using a null_max_threshold of 0.020.

```{r, echo=FALSE,warning=F,message=F}
# Load required libraries
library(tidyverse)
library(ggplot2)
library(patchwork)
library(ROCR)

# ------------------------------
# Helper Functions
# ------------------------------
compute_cs_metrics <- function(credible_sets, truth) {
  if (length(credible_sets) == 0) {
    return(list(cs_fdr = 0, cs_recall = 0))
  }
  TP <- sum(sapply(credible_sets, function(cs) any(cs %in% truth)))
  FP <- length(credible_sets) - TP
  cs_fdr <- ifelse((TP + FP) > 0, FP / (TP + FP), 0)
  recovered <- unique(unlist(credible_sets))
  TP_recall <- sum(truth %in% recovered)
  FN_recall <- length(truth) - TP_recall
  cs_recall <- ifelse((TP_recall + FN_recall) > 0, TP_recall / (TP_recall + FN_recall), 0)
  list(cs_fdr = cs_fdr, cs_recall = cs_recall)
}

# ------------------------------
# Read Files & Compute CS Metrics
# ------------------------------
oligo_path <- "/Users/alexmccreight/Columbia/Research/SuSiE-ASH/SuSiE-ASH/scripts/benchmark/oligo_result_files_final"
files <- list.files(oligo_path, pattern = "\\.rds$", full.names = TRUE)
cs_results <- list()

for (file in files) {
  filename <- basename(file)
  h2total <- as.numeric(str_extract(filename, "(?<=h2total)[0-9.]+"))
  message("Processing file: ", filename)
  file_data <- readRDS(file)

  for (i in seq_along(file_data$all_results)) {
    rep_data <- file_data$all_results[[i]]
    truth_indices <- rep_data$data$causal
    if (length(truth_indices) == 0) next

    methods <- list(
      "SuSiE"        = rep_data$susie_out,
      "SuSiE.ash"    = rep_data$susie_ash_out,
      "SuSiE-inf"    = rep_data$susie_inf_out,
      "Fineboost"    = rep_data$fineboost_out
    )

    for (m in names(methods)) {
      meth_out <- methods[[m]]
      if (m == "Fineboost") {
        cs <- if (!is.null(meth_out$ucos_details$ucos$ucos_index)) {
          meth_out$ucos_details$ucos$ucos_index
        } else {
          list()
        }
      } else if (m == "SuSiE") {
        cs <- if (!is.null(meth_out$sets$cs)) meth_out$sets$cs else list()
      } else {
        cs <- if (!is.null(meth_out$sets)) meth_out$sets else list()
      }

      metrics <- compute_cs_metrics(cs, truth_indices)
      if (is.na(metrics$cs_fdr) || is.na(metrics$cs_recall)) next

      cs_results[[length(cs_results) + 1]] <- data.frame(
        file       = filename,
        replicate  = i,
        h2total    = h2total,
        Method     = m,
        CS_FDR     = metrics$cs_fdr,
        CS_Recall  = metrics$cs_recall,
        stringsAsFactors = FALSE
      )
    }
  }
  rm(file_data); gc()
}

# Combine and filter results
cs_results_df <- bind_rows(cs_results)

# ------------------------------
# Summarize Across All h2 Levels
# ------------------------------
cs_summary <- cs_results_df %>%
  group_by(Method) %>%
  summarise(
    mean_CS_FDR    = mean(CS_FDR, na.rm = TRUE),
    se_CS_FDR      = sd(CS_FDR, na.rm = TRUE) / sqrt(n()),
    mean_CS_Recall = mean(CS_Recall, na.rm = TRUE),
    se_CS_Recall   = sd(CS_Recall, na.rm = TRUE) / sqrt(n()),
    n               = n(),
    .groups = 'drop'
  )

# ------------------------------
# Plotting
# ------------------------------
# FDR Plot
plot_cs_fdr <- ggplot(cs_summary, aes(x = Method, y = mean_CS_FDR, fill = Method)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = mean_CS_FDR - se_CS_FDR,
                    ymax = mean_CS_FDR + se_CS_FDR),
                position = position_dodge(width = 0.7), width = 0.2) +
  labs(
    title = "Oligogenic Simulation: FDR & Power",
    subtitle = "Results averaged across h2 = {0.1, 0.2, 0.3, 0.4}",
    x     = NULL,
    y     = "Mean CS FDR"
  ) +
  theme_minimal() +
  theme(
    plot.subtitle = element_text(color = "azure4", size = 10)
  ) +
  ylim(0, 0.5) +
  geom_hline(yintercept = 0.05, linetype = "dotted") +
  theme(legend.position = "none")

# Recall Plot
plot_cs_recall <- ggplot(cs_summary, aes(x = Method, y = mean_CS_Recall, fill = Method)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = mean_CS_Recall - se_CS_Recall,
                    ymax = mean_CS_Recall + se_CS_Recall),
                position = position_dodge(width = 0.7), width = 0.2) +
  labs(
    title = NULL,
    x     = NULL,
    y     = "Mean CS Power"
  ) +
  theme_minimal() +
  ylim(0, 1) +
  theme(legend.position = "none")

# Display plots together
plot_cs_fdr + plot_cs_recall
```

## ROC Curves

```{r, warning = F, message = F, echo = F}
# ------------------------------
# ROC Curves
# ------------------------------
pooled_data <- list(
  "SuSiE"     = list(truth = numeric(), pips = numeric()),
  "SuSiE-inf" = list(truth = numeric(), pips = numeric()),
  "SuSiE.ash" = list(truth = numeric(), pips = numeric())
)

for (file in files) {
  file_data <- readRDS(file)
  for (i in seq_along(file_data$all_results)) {
    rep_data <- file_data$all_results[[i]]
    truth_indices <- rep_data$data$causal
    if (length(truth_indices) == 0) next
    p <- length(rep_data$data$beta)
    truth_vec <- rep(0, p); truth_vec[truth_indices] <- 1

    methods_list <- list(
      "SuSiE"     = rep_data$susie_out,
      "SuSiE-inf" = rep_data$susie_inf_out,
      "SuSiE.ash" = rep_data$susie_ash_out
    )

    for (m in names(methods_list)) {
      meth_out <- methods_list[[m]]
      pips <- if (m == "SuSiE") meth_out$pip else meth_out$marginal_PIP
      pooled_data[[m]]$truth <- c(pooled_data[[m]]$truth, truth_vec)
      pooled_data[[m]]$pips  <- c(pooled_data[[m]]$pips,  pips)
    }
  }
  rm(file_data); gc()
}

# Compute ROC points and AUC
roc_curves <- list(); auc_values <- list()
for (m in names(pooled_data)) {
  pred <- prediction(pooled_data[[m]]$pips, pooled_data[[m]]$truth)
  perf_roc <- performance(pred, "tpr", "fpr")
  roc_curves[[m]] <- data.frame(
    fpr = unlist(perf_roc@x.values),
    tpr = unlist(perf_roc@y.values)
  )
  auc_values[[m]] <- as.numeric(performance(pred, "auc")@y.values)
}

# Prepare legend labels
method_labels <- c(
  "SuSiE"     = paste0("SuSiE (AUC=", round(auc_values[["SuSiE"]], 3), ")"),
  "SuSiE-inf" = paste0("SuSiE-inf (AUC=", round(auc_values[["SuSiE-inf"]], 3), ")"),
  "SuSiE.ash" = paste0("SuSiE.ash (AUC=", round(auc_values[["SuSiE.ash"]], 3), ")")
)

# Plot ROC Curves
roc_plot <- ggplot() +
  geom_line(data = roc_curves[["SuSiE"]], aes(x = fpr, y = tpr, color = "SuSiE"),     size = 1) +
  geom_line(data = roc_curves[["SuSiE-inf"]], aes(x = fpr, y = tpr, color = "SuSiE-inf"), size = 1) +
  geom_line(data = roc_curves[["SuSiE.ash"]], aes(x = fpr, y = tpr, color = "SuSiE.ash"), size = 1) +
  labs(
    title = "Oligogenic Simulation: Pooled ROC Curves",
    x     = "False Positive Rate (FPR)",
    y     = "True Positive Rate (TPR)",
    subtitle = "Results averaged across h2 = {0.1, 0.2, 0.3, 0.4}"
  ) +
  theme_minimal() +
  theme(
    plot.subtitle = element_text(color = "azure4", size = 10)
  ) +
  scale_color_manual(
    name   = "Method",
    values = c("SuSiE" = "#7CAE00",
               "SuSiE-inf" = "#00BFC4",
               "SuSiE.ash" = "#C77CFF"),
    labels = method_labels
  ) +
  xlim(0, .1)

print(roc_plot)
```

