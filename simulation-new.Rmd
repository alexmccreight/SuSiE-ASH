---
title: "simulation-setting"
output: html_document
date: "2024-08-30"
---

- Total PVE = 40%
- Large Effects / Beta (2-3) explain 24% total PVE
- Medium Effects / Phi (2-3) explain 6% total PVE
- Infinitesimal Effects / Theta (remaining) explain 10% total PVE

```{r}
library(tidyverse)
```


```{r}
X <- readRDS("/Users/alexmccreight/ALEX-TEMP-FOLDER/data/X4")

generate_twas_data <- function(X, n_large_effects = 3, n_medium_effects = 3, 
                               total_pve = 0.4, seed = NULL) {
  # Set seed for reproducibility
  if (!is.null(seed)) set.seed(seed)
  
  # Center and scale X
  X <- scale(X)
  
  n_samples <- nrow(X)
  n_features <- ncol(X)
  
  # Calculate effect sizes
  large_pve <- 0.6 * total_pve
  medium_pve <- 0.15 * total_pve
  small_pve <- 0.25 * total_pve
  
  # Generate effect sizes
  beta <- rep(0, n_features)
  phi <- rep(0, n_features)
  theta <- rnorm(n_features, 0, sqrt(small_pve / n_features))
  
  # Set large effect sizes
  large_indices <- sample(1:n_features, n_large_effects)
  beta[large_indices] <- rnorm(n_large_effects, 0, sqrt(large_pve / n_large_effects))
  
  # Set medium effect sizes
  medium_indices <- sample(setdiff(1:n_features, large_indices), n_medium_effects)
  phi[medium_indices] <- rnorm(n_medium_effects, 0, sqrt(medium_pve / n_medium_effects))
  
  # Generate y
  y <- X %*% beta + X %*% phi + X %*% theta
  
  # Add noise to achieve desired PVE
  var_y <- var(as.vector(y))
  var_epsilon <- var_y * (1 - total_pve) / total_pve
  epsilon <- rnorm(n_samples, 0, sqrt(var_epsilon))
  y <- y + epsilon
  
  # Return results
  return(list(
    y = y,
    true_effects = list(
      beta = beta,
      phi = phi,
      theta = theta
    )
  ))
}

# Example usage:
# X <- matrix(rnorm(1000 * 100), nrow = 1000, ncol = 100)
result <- generate_twas_data(X)
y <- result$y
true_effects <- result$true_effects

true_effects$beta[which(true_effects$beta != 0)]
true_effects$phi[which(true_effects$phi != 0)]
```

```{r}
generate_twas_data <- function(X, n_large_effects = 3, n_medium_effects = 3, 
                               total_pve = 0.4, seed = NULL) {
  # Set seed for reproducibility
  if (!is.null(seed)) set.seed(seed)
  
  # Center and scale X
  X <- scale(X)
  
  n_samples <- nrow(X)
  n_features <- ncol(X)
  
  # Calculate effect sizes
  large_pve <- 0.6 * total_pve
  medium_pve <- 0.15 * total_pve
  small_pve <- 0.25 * total_pve
  
  # Generate effect sizes
  beta <- rep(0, n_features)
  phi <- rep(0, n_features)
  theta <- rnorm(n_features, 0, sqrt(small_pve / n_features))
  
  # Set large effect sizes
  large_indices <- sample(1:n_features, n_large_effects)
  beta[large_indices] <- rnorm(n_large_effects, 0, sqrt(large_pve / n_large_effects))
  
  # Set medium effect sizes
  medium_indices <- sample(setdiff(1:n_features, large_indices), n_medium_effects)
  phi[medium_indices] <- rnorm(n_medium_effects, 0, sqrt(medium_pve / n_medium_effects))
  
  # Generate components of y
  y_beta <- X %*% beta
  y_phi <- X %*% phi
  y_theta <- X %*% theta
  
  # Combine components
  y <- y_beta + y_phi + y_theta
  
  # Calculate actual PVE for each component
  var_y <- var(as.vector(y))
  pve_beta <- var(as.vector(y_beta)) / var_y
  pve_phi <- var(as.vector(y_phi)) / var_y
  pve_theta <- var(as.vector(y_theta)) / var_y
  
  # Add noise to achieve desired PVE
  var_epsilon <- var_y * (1 - total_pve) / total_pve
  epsilon <- rnorm(n_samples, 0, sqrt(var_epsilon))
  y <- y + epsilon
  
  # Recalculate total variance and PVEs after adding noise
  var_y_total <- var(as.vector(y))
  pve_beta <- var(as.vector(y_beta)) / var_y_total
  pve_phi <- var(as.vector(y_phi)) / var_y_total
  pve_theta <- var(as.vector(y_theta)) / var_y_total
  pve_total <- pve_beta + pve_phi + pve_theta
  
  # Return results
  return(list(
    y = y,
    true_effects = list(
      beta = beta,
      phi = phi,
      theta = theta
    ),
    pve = list(
      pve_beta = pve_beta,
      pve_phi = pve_phi,
      pve_theta = pve_theta,
      pve_total = pve_total
    )
  ))
}

# Example usage:
# X <- matrix(rnorm(1000 * 100), nrow = 1000, ncol = 100)
result <- generate_twas_data(X)
y <- result$y
true_effects <- result$true_effects
pve <- result$pve; pve

true_effects$beta[which(true_effects$beta != 0)]
true_effects$phi[which(true_effects$phi != 0)]
```

```{r}
# Set up simulation parameters
n_simulations <- 100

# Run simulations
set.seed(42)  # for reproducibility
simulation_results <- replicate(n_simulations, {
  result <- generate_twas_data(X)
  c(result$pve, list(beta = result$true_effects$beta, phi = result$true_effects$phi))
}, simplify = FALSE)

pve_data <- do.call(rbind, lapply(simulation_results, function(x) {
  c(x$pve_beta, x$pve_phi, x$pve_theta, x$pve_total)
}))
colnames(pve_data) <- c("pve_beta", "pve_phi", "pve_theta", "pve_total")

beta_data <- unlist(lapply(simulation_results, function(x) x$beta[x$beta != 0]))
phi_data <- unlist(lapply(simulation_results, function(x) x$phi[x$phi != 0]))

# Create summary dataframe
summary_df <- data.frame(
  metric = c("PVE Beta", "PVE Phi", "PVE Theta", "Total PVE", 
             "Non-zero Beta Effect Sizes", "Non-zero Phi Effect Sizes"),
  average = c(colMeans(pve_data), mean(abs(beta_data)), mean(abs(phi_data)))
)

# Create histograms
pve_long <- pve_data %>%
  as.data.frame() %>%
  pivot_longer(cols = everything(), names_to = "PVE_type", values_to = "value")

pve_hist <- ggplot(pve_long, aes(x = value, fill = PVE_type)) +
  geom_histogram(bins = 30, alpha = 0.7, position = "identity") +
  facet_wrap(~PVE_type, scales = "free") +
  theme_minimal() +
  labs(title = "Distribution of PVE", x = "PVE", y = "Count")

# beta_hist <- ggplot(data.frame(beta = beta_data), aes(x = beta)) +
#   geom_histogram(bins = 30, fill = "blue", alpha = 0.7) +
#   theme_minimal() +
#   labs(title = "Distribution of Non-zero Beta Effect Sizes", x = "Effect Size", y = "Count")
# 
# phi_hist <- ggplot(data.frame(phi = phi_data), aes(x = phi)) +
#   geom_histogram(bins = 30, fill = "red", alpha = 0.7) +
#   theme_minimal() +
#   labs(title = "Distribution of Non-zero Phi Effect Sizes", x = "Effect Size", y = "Count")

# Combine the beta_data and phi_data into a single data frame
combined_data <- data.frame(
  EffectSize = c(beta_data, phi_data),
  Type = rep(c("Beta", "Phi"), times = c(length(beta_data), length(phi_data)))
)

# Plot the overlapping histograms
combined_hist <- ggplot(combined_data, aes(x = EffectSize, fill = Type)) +
  geom_histogram(alpha = 0.5, position = "identity", bins = 30) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_minimal() +
  labs(title = "Comparison of Beta and Phi Effect Sizes", x = "Effect Size", y = "Count")

# Display the plot
print(combined_hist)

# Display histograms
print(pve_hist)
# print(beta_hist)
# print(phi_hist)

# Summary Dataframe
print(summary_df)
```


