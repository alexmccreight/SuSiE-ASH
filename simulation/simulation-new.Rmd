---
title: "simulation-setting"
output: html_document
date: "2024-08-30"
---

```{r}
#X <- readRDS("/Users/alexmccreight/Columbia/data/X20")
X <- readRDS("/Users/alexmccreight/ALEX-TEMP-FOLDER/data/X20")

generate_data <- function(X,
                          n_large_effects = 3,      # Adjusted number of large effects
                          n_medium_effects = 50,    # Adjusted number of medium effects
                          total_pve = 0.35,
                          seed = NULL) {
  # Set seed for reproducibility
  if (!is.null(seed)) set.seed(seed)
  
  # Center and scale X
  X <- scale(X)
  
  n_samples <- nrow(X)
  n_features <- ncol(X)
  
  # Calculate effect sizes
  large_pve <- 0.30 * total_pve 
  medium_pve <- 0.10 * total_pve 
  small_pve <- 0.60 * total_pve 
  
  # Initialize effect sizes
  beta <- rep(0, n_features)
  phi <- rep(0, n_features)
  theta <- rep(0, n_features)
  
  # Set large effect sizes (mean = 0, SD = 0.15)
  large_indices <- sample(1:n_features, n_large_effects)
  beta[large_indices] <- rnorm(n_large_effects, mean = 0, sd = 0.15)
  
  # Set medium effect sizes (mean = 0, SD = 0.025)
  remaining_indices <- setdiff(1:n_features, large_indices)
  n_medium_effects <- min(n_medium_effects, length(remaining_indices))
  medium_indices <- sample(remaining_indices, n_medium_effects)
  phi[medium_indices] <- rnorm(n_medium_effects, mean = 0, sd = 0.025)
  
  # Set infinitesimal effect sizes (mean = 0, SD = 0.0005)
  small_indices <- setdiff(remaining_indices, medium_indices)
  n_small_effects <- length(small_indices)
  theta[small_indices] <- rnorm(n_small_effects, mean = 0, sd = 0.0005)
  
  # Generate components of y
  Xbeta <- X %*% beta
  Xphi <- X %*% phi
  Xtheta <- X %*% theta
  
  # Calculate initial variances
  var_Xbeta <- var(as.vector(Xbeta))
  var_Xphi <- var(as.vector(Xphi))
  var_Xtheta <- var(as.vector(Xtheta))
  
  # Scale components to match desired PVE
  Xbeta <- Xbeta * sqrt(large_pve / var_Xbeta)
  Xphi <- Xphi * sqrt(medium_pve / var_Xphi)
  Xtheta <- Xtheta * sqrt(small_pve / var_Xtheta)
  
  # Combine components
  y_signal <- Xbeta + Xphi + Xtheta
  var_signal <- var(as.vector(y_signal))
  
  # Add noise to achieve desired total PVE
  var_epsilon <- var_signal * ((1 - total_pve) / total_pve)
  epsilon <- rnorm(n_samples, 0, sqrt(var_epsilon))
  y <- y_signal + epsilon
  
  # Recalculate total variance and PVEs after adding noise
  var_y_total <- var(as.vector(y))
  pve_beta <- var(as.vector(Xbeta)) / var_y_total
  pve_phi <- var(as.vector(Xphi)) / var_y_total
  pve_theta <- var(as.vector(Xtheta)) / var_y_total
  pve_total <- pve_beta + pve_phi + pve_theta
  
  # Scale + center y (for no intercept)
  y <- scale(y, center = TRUE, scale = FALSE)
  
  # Return results
  return(list(
    X = X,
    y = y,
    var_epsilon = var_epsilon,
    beta = beta,
    phi = phi,
    theta = theta,
    pve_beta = pve_beta,
    pve_phi = pve_phi,
    pve_theta = pve_theta,
    pve_total = pve_total
  ))
}

# After running the function:
result <- generate_data(X)

# Inspect effect sizes
hist(result$beta[result$beta != 0], main = "Large Effect Sizes (beta)", xlab = "Effect Size")
hist(result$phi[result$phi != 0], main = "Medium Effect Sizes (phi)", xlab = "Effect Size")
hist(result$theta[result$theta != 0], main = "Small Effect Sizes (theta)", xlab = "Effect Size")

# Check ranges
range(result$beta[result$beta != 0])
range(result$phi[result$phi != 0])
range(result$theta[result$theta != 0])

result$pve_beta
result$pve_phi
result$pve_theta
#result$var_epsilon

result$pve_beta + result$pve_phi + result$pve_theta



# sum(result$beta[result$beta != 0]^2)
# sum(result$phi[result$phi != 0]^2)
# sum(result$theta[result$theta != 0]^2)

```

```{r}
devtools::load_all('/Users/alexmccreight/Columbia/Research/SuSiE-ASH/SuSiE-ASH/submodules/mr.ash.alpha')
devtools::load_all('/Users/alexmccreight/Columbia/Research/SuSiE-ASH/SuSiE-ASH/submodules/susieR')
#source("/Users/alexmccreight/Columbia/Research/SuSiE-ASH/SuSiE-ASH/code/susie_versions/susie-ash-v2.R")
source("/Users/alexmccreight/Columbia/Research/SuSiE-ASH/SuSiE-ASH/code/susie_versions/susie-ash.R")
source("/Users/alexmccreight/Columbia/Research/SuSiE-ASH/SuSiE-ASH/code/susie_versions/susie_inf.R")

susie_output <- susie(X = result$X, y = result$y, L = 10, standardize = F, intercept = F)
susie_inf_output <- susie_inf(X = result$X, y = result$y, L = 10)


which(result$beta != 0)

susie_output$sets$cs
susie_inf_output$sets
```

