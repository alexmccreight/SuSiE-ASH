---
title: "SuSiE-INF DEBUG"
output: html_document
date: "2024-05-20"
---

```{r}
# Read in data from susieinf.py example
library(tidyverse)
# X <- read.csv("/Users/alexmccreight/Columbia/Research/SuSiE-ASH/fine-mapping-inf/X_matrix.csv", header = F)
# y <- read.csv("/Users/alexmccreight/Columbia/Research/SuSiE-ASH/fine-mapping-inf/y_vector.csv", header = F)
# X <- as.matrix(X)
# y <- as.matrix(y)

devtools::load_all('/Users/alexmccreight/ALEX-TEMP-FOLDER/SuSiE-ASH/submodules/susieR')
devtools::load_all('/Users/alexmccreight/ALEX-TEMP-FOLDER/SuSiE-ASH/submodules/mr.ash.alpha')
source("/Users/alexmccreight/ALEX-TEMP-FOLDER/SuSiE-ASH/code/susie_versions/susie_inf.R")
source("/Users/alexmccreight/ALEX-TEMP-FOLDER/SuSiE-ASH/code/susie_versions/susie-ash.R")

```

```{r}
# Define constants
# set.seed(1)
# X <- readRDS("/Users/alexmccreight/ALEX-TEMP-FOLDER/SuSiE-ASH/data/X20")
# X <- scale(X, center = T, scale = T)
# n <- nrow(X)
# p <- ncol(X)
# MAF <- 0.1
# Ltrue <- 5
# ssq <- 0.01
# sigmasq <- 1

# Generate genotype matrix X
set.seed(100)
n = 5000
p = 500
MAF = 0.1
Ltrue = 5
ssq = 0.01
sigmasq = 1
X <- matrix(rbinom(n * p, size = 2, prob = MAF), nrow = n, ncol = p)
X <- scale(X, center = T, scale = T)  # Center and scale

# Initialize effects vector b and select indices for true effects
b <- rep(0, p)
inds <- sample(p, Ltrue, replace = FALSE)
b[inds] <- rnorm(Ltrue) * sqrt(ssq)
order <- order(inds)

cat(sprintf('True effects: %s', toString(inds[order])), "\n")
cat(sprintf('Effect sizes: %s\n', toString(b[inds[order]])), "\n")

# Generate data with strong infinitesimal effects, tau^2 = 1e-3
cat('###### Simulating with strong infinitesimal effects, tau^2 = 1e-3 ######', "\n")
#tausq <- 1e-4
tausq <- 5e-4
#tausq <- 1e-3
theta <- rnorm(p) * sqrt(tausq)
effects <- X %*% b + X %*% theta
y <- effects + rnorm(n) * sqrt(sigmasq)
y <- scale(y, center = T, scale = T)
total_variance_explained <- var(effects) / var(y)

cat(sprintf('Total fraction of variance explained by SNPs: %f\n', total_variance_explained), "\n")


### METHODS ###
susie_inf_output <- susie_inf(X = X, y = y, L = 5, coverage = 0.9, verbose = F)
susie_ash_output <- susie_ash(X = X, y = y, L = 5, standardize = F, intercept = F, max_iter = 20, warm_start = 3)
susie_output <- susie(X = X, y = y, L = 5, standardize = F, intercept = F)
mrash_output <- mr.ash(X = X, y = y, intercept = F)

# susie_inf_output <- susie_inf(X = data$X, y = data$y, L = 10, coverage = 0.9, verbose = F)
# susie_ash_output <- susie_ash(X = data$X, y = data$y, L = 10, standardize = F, intercept = F, max_iter = 100, warm_start = 3)
# susie_output <- susie(X = data$X, y = data$y, L = 10, standardize = F, intercept = F)
# mrash_output <- mr.ash(X = data$X, y = data$y, intercept = F)

### FINE-MAPPING RESULTS ###
cat(sprintf('True effects: %s', toString(inds[order])), "\n")
cat(sprintf('Effect sizes: %s\n', toString(b[inds[order]])), "\n")
susie_inf_output$sets %in% inds
susie_get_cs(susie_output, X = X, coverage = 0.9)$cs %in% inds
susie_get_cs(susie_ash_output, X = X, coverage = 0.9)$cs %in% inds

### PREDICTION RESULTS ###

# True Values
Xbeta <- X %*% b
Xtheta <- X %*% theta

# Xbeta <- data$X %*% matrix(data$beta, ncol = 1)
# Xtheta <- data$X %*% matrix(data$theta, ncol = 1)
# y = data$y
# X = data$X

# susie RMSE
susie_y <- sqrt(mean((y - susie_output$fitted)^2))
susie_xb <- sqrt(mean((Xbeta - susie_output$Xr)^2))

# susie-ash RMSE
susieash_y <- sqrt(mean((y - susie_ash_output$fitted)^2))
susieash_xb <- sqrt(mean((Xbeta - susie_ash_output$Xr)^2))
susieash_xtheta <- sqrt(mean((Xtheta - susie_ash_output$Xtheta)^2))

# susie-inf RMSE
susieinf_y <- sqrt(mean((y - susie_inf_output$fitted)^2))
susieinf_xb <- sqrt(mean((Xbeta - X %*% rowSums(susie_inf_output$PIP2 * susie_inf_output$mu))^2))
susieinf_xtheta <- sqrt(mean((Xtheta - X %*% rowSums(susie_inf_output$PIP2 * susie_inf_output$alpha))^2))

# mr. ash RMSE
mrash_y <- sqrt(mean((y - predict(mrash_output, X))^2))

tmp <- susie(X = X, y = y, L = 5, standardize = F, intercept = F)
high_heritability_ls <- which(tmp$V >= 0.001)
resid = y - X %*% colSums(tmp$alpha[high_heritability_ls,] * tmp$mu[high_heritability_ls,])
susie_ash_testing <- mr.ash(X = X, y = resid, standardize = F, intercept = F)

# susie ash testing RMSE
susieashtesting_y <- sqrt(mean((y - predict(susie_ash_testing, X))^2))

#### Combined Results ####

data.frame(Model = c('susie', 'susie-ash', 'susie-inf', 'mr.ash', 'testing susie-ash'),
           MSE_y = c(susie_y, susieash_y, susieinf_y, mrash_y, susieashtesting_y),
           MSE_b = c(susie_xb, susieash_xb, susieinf_xb, NA, NA),
           MSE_theta = c(NA, susieash_xtheta, susieinf_xtheta, NA, NA))
```

```{r}
set.seed(1)
n = 1000
p = 1000
beta = rep(0,p)
beta[1:4] = 1
X = matrix(rnorm(n*p),nrow = n,ncol = p)
X = scale(X,center = TRUE,scale = TRUE)
y = 3 + drop(X %*% beta + rnorm(n))

susie_ash_output <- susie_ash(X = X, y = y, L = 5, standardize = F, intercept = T, max_iter = 20, warm_start = 3)
susie_output <- susie(X = X, y = y, L = 5, standardize = F, intercept = T)

susie_output$intercept
susie_ash_output$intercept

```

